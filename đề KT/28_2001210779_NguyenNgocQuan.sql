CREATE DATABASE QL_TAILIEU
USE QL_TAILIEU

CREATE TABLE TAILIEU (
    MATL INT PRIMARY KEY,
    TENTL VARCHAR(255),
    TACGIA VARCHAR(255)
);
CREATE TABLE KHACH (
    MAKH INT PRIMARY KEY,
    HOTEN VARCHAR(255),
    PHAI VARCHAR(3),
    SODT VARCHAR(15)
);
CREATE TABLE DANGKY (
    MADK INT PRIMARY KEY,
    MAKH INT,
    MATL INT,
    SOLUONGDK INT,
    NGAYDK DATE,
    FOREIGN KEY (MAKH) REFERENCES KHACH(MAKH),
    FOREIGN KEY (MATL) REFERENCES TAILIEU(MATL)
);
CREATE TABLE GIAOTAILIEU (
    MADK INT,
    LANGIAO INT,
    SOLUONGGIAO INT,
    NGAYGIAO DATE,
    FOREIGN KEY (MADK) REFERENCES DANGKY(MADK)
);

INSERT INTO TAILIEU VALUES (1, 'Tieu thuyet A', 'Tac gia A');
INSERT INTO TAILIEU VALUES (2, 'Sach giao khoa B', 'Tac gia B');
INSERT INTO TAILIEU VALUES (3, 'Truyen ngan C', 'Tac gia C');

INSERT INTO KHACH VALUES (1, 'Nguyen Van A', 'Nam', '123456789');
INSERT INTO KHACH VALUES (2, 'Tran Thi B', 'Nu', '987654321');
INSERT INTO KHACH VALUES (3, 'Le Van C', 'Nam', '456789012');

INSERT INTO DANGKY VALUES (101, 1, 1, 2, '2023-01-01');
INSERT INTO DANGKY VALUES (102, 2, 2, 1, '2023-02-01');
INSERT INTO DANGKY VALUES (103, 3, 3, 3, '2023-03-01');

INSERT INTO GIAOTAILIEU VALUES (101, 1, 2, '2023-01-15');
INSERT INTO GIAOTAILIEU VALUES (102, 2, 1, '2023-02-15');
INSERT INTO GIAOTAILIEU VALUES (103, 3, 3, '2023-03-15');

SELECT DANGKY.MATL, TAILIEU.TENTL, DANGKY.NGAYDK
FROM DANGKY
JOIN TAILIEU ON DANGKY.MATL = TAILIEU.MATL
WHERE YEAR(DANGKY.NGAYDK) = 2023 AND MONTH(DANGKY.NGAYDK) BETWEEN 4 AND 6;

SELECT TOP 1 TAILIEU.MATL, TAILIEU.TENTL
FROM TAILIEU
JOIN DANGKY ON TAILIEU.MATL = DANGKY.MATL
GROUP BY TAILIEU.MATL, TAILIEU.TENTL
ORDER BY SUM(DANGKY.SOLUONGDK) DESC;

CREATE PROCEDURE DanhSachKhachHangDangKyTaiLieu
    @p_MATL INT
AS
BEGIN
    SELECT DANGKY.MAKH, KHACH.HOTEN, DANGKY.SOLUONGDK, DANGKY.NGAYDK
    FROM DANGKY
    JOIN KHACH ON DANGKY.MAKH = KHACH.MAKH
    WHERE DANGKY.MATL = @p_MATL;
END;
EXEC DanhSachKhachHangDangKyTaiLieu @p_MATL = 1;

CREATE FUNCTION dbo.TongSoLuongSachChuaGiao(@p_MAKH INT)
RETURNS INT
AS
BEGIN
    DECLARE @tongSoLuongSach INT;

    SELECT @tongSoLuongSach = SUM(DANGKY.SOLUONGDK) - COALESCE(SUM(GIAOTAILIEU.SOLUONGGIAO), 0)
    FROM DANGKY
    LEFT JOIN GIAOTAILIEU ON DANGKY.MADK = GIAOTAILIEU.MADK
    WHERE DANGKY.MAKH = @p_MAKH;
    IF @tongSoLuongSach <= 0
    BEGIN
        SET @tongSoLuongSach = -1;
    END
    RETURN @tongSoLuongSach;
END;

DECLARE @result INT;
SET @result = dbo.TongSoLuongSachChuaGiao(2);
SELECT @result;

CREATE TRIGGER Trig_KiemTraNgayGiao
ON GIAOTAILIEU
AFTER INSERT
AS
BEGIN
    DECLARE @ngayDK DATE;
    SELECT @ngayDK = NGAYDK
    FROM DANGKY
    WHERE MADK IN (SELECT MADK FROM INSERTED);
    IF (SELECT COUNT(*) FROM INSERTED WHERE NGAYGIAO IS NOT NULL AND NGAYGIAO <= @ngayDK) > 0
    BEGIN
        THROW 50000, 'Ngày giao tài liệu phải sau ngày đăng ký mua tài liệu.', 1;
    END;
END;

INSERT INTO DANGKY (MADK, MAKH, MATL, SOLUONGDK, NGAYDK) VALUES (1, 1, 1, 2, '2023-01-01');
INSERT INTO GIAOTAILIEU (MADK, LANGIAO, SOLUONGGIAO, NGAYGIAO) VALUES (1, 1, 2, '2023-01-15');
INSERT INTO DANGKY (MADK, MAKH, MATL, SOLUONGDK, NGAYDK) VALUES (2, 2, 2, 1, '2023-02-01');
INSERT INTO GIAOTAILIEU (MADK, LANGIAO, SOLUONGGIAO, NGAYGIAO) VALUES (2, 2, 1, '2023-02-15');



SELECT DANGKY.MADK
FROM DANGKY
LEFT JOIN GIAOTAILIEU ON DANGKY.MADK = GIAOTAILIEU.MADK
GROUP BY DANGKY.MADK, DANGKY.SOLUONGDK
HAVING SUM(GIAOTAILIEU.SOLUONGGIAO) < DANGKY.SOLUONGDK;

USE master;
IF NOT EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = N'QL_TAILIEU')
BEGIN
    CREATE DATABASE QL_TAILIEU;
    USE QL_TAILIEU;
    CREATE TABLE TAILIEU (MATL INT PRIMARY KEY, TENTL NVARCHAR(255), TACGIA NVARCHAR(255));
    INSERT INTO TAILIEU VALUES (1, N'Tieu thuyet A', N'Tac gia A');
END
BACKUP DATABASE QL_TAILIEU TO DISK = 'C:\Backup\QL_TAILIEU_Full.bak';
BACKUP DATABASE QL_TAILIEU TO DISK = 'C:\Backup\QL_TAILIEU_Diff.bak' WITH DIFFERENTIAL;
BACKUP LOG QL_TAILIEU TO DISK = 'C:\Backup\QL_TAILIEU_Log.bak';

USE master;
IF EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = N'QL_TAILIEU')
BEGIN
    ALTER DATABASE QL_TAILIEU SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE QL_TAILIEU;
END
RESTORE DATABASE QL_TAILIEU FROM DISK = 'C:\Backup\QL_TAILIEU_Full.bak' WITH REPLACE, NORECOVERY;
RESTORE DATABASE QL_TAILIEU FROM DISK = 'C:\Backup\QL_TAILIEU_Diff.bak' WITH RECOVERY;
RESTORE LOG QL_TAILIEU FROM DISK = 'C:\Backup\QL_TAILIEU_Log.bak' WITH RECOVERY;


